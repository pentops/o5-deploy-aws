// Code generated by protoc-gen-go-psm. DO NOT EDIT.

package deployer_pb

import (
	context "context"
	psm_pb "github.com/pentops/protostate/gen/state/v1/psm_pb"
	psm "github.com/pentops/protostate/psm"
	sqrlx "github.com/pentops/sqrlx.go/sqrlx"
	proto "google.golang.org/protobuf/proto"
)

// StateObjectOptions: StackPSM
type StackPSM = psm.StateMachine[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
]

type StackPSMDB = psm.DBStateMachine[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
]

type StackPSMEventer = psm.Eventer[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
]

func DefaultStackPSMConfig() *psm.StateMachineConfig[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
] {
	return psm.NewStateMachineConfig[
		*StackKeys,
		*StackState,
		StackStatus,
		*StackEvent,
		StackPSMEvent,
	](DefaultStackPSMTableSpec)
}

func NewStackPSM(config *psm.StateMachineConfig[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
]) (*StackPSM, error) {
	return psm.NewStateMachine[
		*StackKeys,
		*StackState,
		StackStatus,
		*StackEvent,
		StackPSMEvent,
	](config)
}

type StackPSMTableSpec = psm.PSMTableSpec[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
]

var DefaultStackPSMTableSpec = StackPSMTableSpec{
	State: psm.TableSpec[*StackState]{
		TableName:  "stack",
		DataColumn: "state",
		StoreExtraColumns: func(state *StackState) (map[string]interface{}, error) {
			return map[string]interface{}{}, nil
		},
		PKFieldPaths: []string{
			"keys.stack_id",
		},
	},
	Event: psm.TableSpec[*StackEvent]{
		TableName:  "stack_event",
		DataColumn: "data",
		StoreExtraColumns: func(event *StackEvent) (map[string]interface{}, error) {
			metadata := event.Metadata
			return map[string]interface{}{
				"id":        metadata.EventId,
				"timestamp": metadata.Timestamp,
				"cause":     metadata.Cause,
				"sequence":  metadata.Sequence,
				"stack_id":  event.Keys.StackId,
			}, nil
		},
		PKFieldPaths: []string{
			"metadata.EventId",
		},
		PK: func(event *StackEvent) (map[string]interface{}, error) {
			return map[string]interface{}{
				"id": event.Metadata.EventId,
			}, nil
		},
	},
	PrimaryKey: func(event *StackEvent) (map[string]interface{}, error) {
		return map[string]interface{}{
			"id": event.Keys.StackId,
		}, nil
	},
}

type StackPSMTransitionBaton = psm.TransitionBaton[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
]

type StackPSMHookBaton = psm.StateHookBaton[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
]

func StackPSMFunc[SE StackPSMEvent](cb func(context.Context, StackPSMTransitionBaton, *StackState, SE) error) psm.PSMCombinedFunc[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
	SE,
] {
	return psm.PSMCombinedFunc[
		*StackKeys,
		*StackState,
		StackStatus,
		*StackEvent,
		StackPSMEvent,
		SE,
	](cb)
}
func StackPSMTransition[SE StackPSMEvent](cb func(context.Context, *StackState, SE) error) psm.PSMTransitionFunc[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
	SE,
] {
	return psm.PSMTransitionFunc[
		*StackKeys,
		*StackState,
		StackStatus,
		*StackEvent,
		StackPSMEvent,
		SE,
	](cb)
}
func StackPSMHook[SE StackPSMEvent](cb func(context.Context, sqrlx.Transaction, StackPSMHookBaton, *StackState, SE) error) psm.PSMHookFunc[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
	SE,
] {
	return psm.PSMHookFunc[
		*StackKeys,
		*StackState,
		StackStatus,
		*StackEvent,
		StackPSMEvent,
		SE,
	](cb)
}
func StackPSMGeneralHook(cb func(context.Context, sqrlx.Transaction, *StackState, *StackEvent) error) psm.GeneralStateHook[
	*StackKeys,
	*StackState,
	StackStatus,
	*StackEvent,
	StackPSMEvent,
] {
	return psm.GeneralStateHook[
		*StackKeys,
		*StackState,
		StackStatus,
		*StackEvent,
		StackPSMEvent,
	](cb)
}

type StackPSMEventKey = string

const (
	StackPSMEventNil                 StackPSMEventKey = "<nil>"
	StackPSMEventConfigured          StackPSMEventKey = "configured"
	StackPSMEventTriggered           StackPSMEventKey = "triggered"
	StackPSMEventDeploymentCompleted StackPSMEventKey = "deployment_completed"
	StackPSMEventDeploymentFailed    StackPSMEventKey = "deployment_failed"
	StackPSMEventAvailable           StackPSMEventKey = "available"
)

type StackPSMEvent interface {
	proto.Message
	PSMEventKey() StackPSMEventKey
}

func (etw *StackEventType) UnwrapPSMEvent() StackPSMEvent {
	if etw == nil {
		return nil
	}
	switch v := etw.Type.(type) {
	case *StackEventType_Configured_:
		return v.Configured
	case *StackEventType_Triggered_:
		return v.Triggered
	case *StackEventType_DeploymentCompleted_:
		return v.DeploymentCompleted
	case *StackEventType_DeploymentFailed_:
		return v.DeploymentFailed
	case *StackEventType_Available_:
		return v.Available
	default:
		return nil
	}
}
func (etw *StackEventType) PSMEventKey() StackPSMEventKey {
	tt := etw.UnwrapPSMEvent()
	if tt == nil {
		return StackPSMEventNil
	}
	return tt.PSMEventKey()
}
func (etw *StackEventType) SetPSMEvent(inner StackPSMEvent) {
	switch v := inner.(type) {
	case *StackEventType_Configured:
		etw.Type = &StackEventType_Configured_{Configured: v}
	case *StackEventType_Triggered:
		etw.Type = &StackEventType_Triggered_{Triggered: v}
	case *StackEventType_DeploymentCompleted:
		etw.Type = &StackEventType_DeploymentCompleted_{DeploymentCompleted: v}
	case *StackEventType_DeploymentFailed:
		etw.Type = &StackEventType_DeploymentFailed_{DeploymentFailed: v}
	case *StackEventType_Available:
		etw.Type = &StackEventType_Available_{Available: v}
	default:
		panic("invalid type")
	}
}

func (ee *StackEvent) PSMEventKey() StackPSMEventKey {
	return ee.Event.PSMEventKey()
}

func (ee *StackEvent) UnwrapPSMEvent() StackPSMEvent {
	return ee.Event.UnwrapPSMEvent()
}

func (ee *StackEvent) SetPSMEvent(inner StackPSMEvent) {
	if ee.Event == nil {
		ee.Event = &StackEventType{}
	}
	ee.Event.SetPSMEvent(inner)
}

func (*StackEventType_Configured) PSMEventKey() StackPSMEventKey {
	return StackPSMEventConfigured
}
func (*StackEventType_Triggered) PSMEventKey() StackPSMEventKey {
	return StackPSMEventTriggered
}
func (*StackEventType_DeploymentCompleted) PSMEventKey() StackPSMEventKey {
	return StackPSMEventDeploymentCompleted
}
func (*StackEventType_DeploymentFailed) PSMEventKey() StackPSMEventKey {
	return StackPSMEventDeploymentFailed
}
func (*StackEventType_Available) PSMEventKey() StackPSMEventKey {
	return StackPSMEventAvailable
}
func (ee *StackEvent) PSMMetadata() *psm_pb.EventMetadata {
	if ee.Metadata == nil {
		ee.Metadata = &psm_pb.EventMetadata{}
	}
	return ee.Metadata
}

func (st *StackState) PSMMetadata() *psm_pb.StateMetadata {
	if st.Metadata == nil {
		st.Metadata = &psm_pb.StateMetadata{}
	}
	return st.Metadata
}

func (ee *StackEvent) PSMKeys() *StackKeys {
	return ee.Keys
}

func (ee *StackEvent) SetPSMKeys(inner *StackKeys) {
	ee.Keys = inner
}

func (st *StackState) PSMKeys() *StackKeys {
	return st.Keys
}

func (st *StackState) SetPSMKeys(inner *StackKeys) {
	st.Keys = inner
}
